<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Citoyen Survivor ‚Äî √âtape 1 (Pixel Art)</title>
  <style>
    :root{
      --bg:#0a0c10;--ink:#ecf1ff;--muted:#9aa8c6;--accent:#ff4d6d;--gold:#ffd166;
      --scan:rgba(255,255,255,.06);--vign:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 40% -10%,#0e1220 0%,#0a0c10 60%),#0a0c10;color:var(--ink);font-family:"Press Start 2P",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Noto Sans",sans-serif}
    #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr}
    canvas{display:block;width:100%;height:100%;touch-action:none}

    /* HUD minimal pixel */
    .hud{position:fixed;left:8px;top:8px;display:flex;gap:8px;align-items:center;pointer-events:none}
    .chip{font-size:10px;letter-spacing:0.5px;background:rgba(10,12,16,.6);border:2px solid rgba(255,255,255,.15);border-radius:4px;padding:6px 8px;box-shadow:0 4px 0 rgba(0,0,0,.4)}
    .pauseBtn{position:fixed;top:8px;right:8px;font-size:10px;background:rgba(10,12,16,.6);border:2px solid rgba(255,255,255,.15);border-radius:4px;padding:8px 10px;color:var(--ink);cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.4)}

    /* Start / Over */
    .veil{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.65))}
    .card{width:min(680px,92vw);background:rgba(12,16,26,.92);border:2px solid rgba(255,255,255,.18);border-radius:6px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .title{font-size:18px;margin:0 0 8px}
    .subtitle{color:var(--muted);font-size:11px;line-height:1.6;margin:0 0 12px}
    .btn{display:inline-block;background:#1b2336;border:2px solid rgba(255,255,255,.25);color:var(--ink);padding:10px 12px;border-radius:6px;cursor:pointer}

    /* Mobile controls */
    .joystick{position:fixed;left:16px;bottom:16px;width:120px;height:120px;border-radius:50%;background:rgba(12,16,26,.5);border:2px solid rgba(255,255,255,.15);touch-action:none}
    .stick{position:absolute;left:50%;top:50%;width:54px;height:54px;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.12);border:2px solid rgba(255,255,255,.25)}
    .actions{position:fixed;right:12px;bottom:16px;display:flex;gap:12px}
    .round{width:66px;height:66px;border-radius:50%;border:2px solid rgba(255,255,255,.25);background:rgba(12,16,26,.5);display:grid;place-items:center;font-size:20px}

    /* CRT overlay */
    .crt{position:fixed;inset:0;pointer-events:none;mix-blend-mode:overlay}
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="screen"></canvas>

    <!-- HUD -->
    <div class="hud">
      <div class="chip" id="timer">00:00</div>
      <div class="chip" id="lvl">LV 1</div>
      <div class="chip" id="gold">üó≥Ô∏è 0</div>
    </div>
    <button class="pauseBtn" id="pause">PAUSE</button>

    <!-- Start -->
    <div class="veil" id="start">
      <div class="card">
        <div class="title">CITOYEN SURVIVOR ‚Äî PIXEL PROTO</div>
        <p class="subtitle">√âtape 1 : **refonte visuelle** en pixel art underground.<br/>Tu es un citoyen qui tient l'ar√®ne. D√©place-toi, les id√©es partent toutes seules. Sur mobile : joystick virtuel.</p>
        <button class="btn" id="play">‚ñ∂Ô∏è JOUER</button>
      </div>
    </div>

    <!-- Over -->
    <div class="veil" id="over" style="display:none">
      <div class="card">
        <div class="title">FIN</div>
        <p class="subtitle" id="stats"></p>
        <button class="btn" onclick="location.reload()">‚Üª REJOUER</button>
      </div>
    </div>

    <!-- Mobile controls -->
    <div class="joystick" id="joy"><div class="stick" id="stick"></div></div>
    <div class="actions">
      <div class="round" id="dashBtn" title="Dash">‚ö°</div>
      <div class="round" id="bombBtn" title="Appel citoyen">üì£</div>
    </div>

    <!-- CRT overlay canvas -->
    <canvas class="crt" id="crt"></canvas>
  </div>

<script>
(function(){
  // ‚Äî‚Äî Virtual resolution for pixel art ‚Äî‚Äî
  const VIRT_W = 192; // base logical width
  const VIRT_H = 108; // base logical height (16:9)

  const screen = document.getElementById('screen');
  const ctx = screen.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const crt = document.getElementById('crt');
  const crtx = crt.getContext('2d');
  crtx.imageSmoothingEnabled = false;

  let W=0,H=0,S=1; // real size & scale factor
  const off = document.createElement('canvas');
  off.width = VIRT_W; off.height = VIRT_H; const g = off.getContext('2d');
  g.imageSmoothingEnabled = false;

  function fit(){
    W=innerWidth; H=innerHeight;
    // integer scale to keep crispy pixels
    S = Math.max(1, Math.floor(Math.min(W/VIRT_W, H/VIRT_H)));
    const viewW = VIRT_W * S, viewH = VIRT_H * S;
    screen.width = viewW; screen.height = viewH; screen.style.width=viewW+'px'; screen.style.height=viewH+'px';
    crt.width=viewW; crt.height=viewH; crt.style.width=viewW+'px'; crt.style.height=viewH+'px';
    screen.style.position = crt.style.position = 'fixed';
    const left = Math.floor((W-viewW)/2), top = Math.floor((H-viewH)/2);
    screen.style.left = crt.style.left = left+'px';
    screen.style.top  = crt.style.top  = top +'px';
  }
  addEventListener('resize',fit); fit();

  // ‚Äî‚Äî Game State ‚Äî‚Äî
  const state={
    running:false, over:false, time:0, level:1, gold:0,
    player:{x:VIRT_W/2,y:VIRT_H/2, r:6, spd:45, hp:100, max:100, ifr:0, dash:0, dashCd:0, dir:0},
    proj:[], enemies:[], orbs:[], particles:[],
    weapon:{cd:0, rate:0.55, dmg:6, speed:85, spread:0.22, bullets:1}
  };

  // ‚Äî‚Äî UI ‚Äî‚Äî
  const startEl = document.getElementById('start');
  const overEl  = document.getElementById('over');
  const statsEl = document.getElementById('stats');
  const playBtn = document.getElementById('play');
  const pauseBtn= document.getElementById('pause');
  const timerEl = document.getElementById('timer');
  const lvlEl   = document.getElementById('lvl');
  const goldEl  = document.getElementById('gold');

  function start(){ state.running=true; last=performance.now(); loop(); }
  function onPlay(e){ e&&e.preventDefault(); startEl.style.display='none'; start(); }
  playBtn.addEventListener('click',onPlay,{passive:false});
  playBtn.addEventListener('touchend',onPlay,{passive:false});
  pauseBtn.addEventListener('click',()=>{state.running=!state.running; pauseBtn.textContent=state.running?'PAUSE':'‚ñ∂Ô∏è'});

  // ‚Äî‚Äî Input (joystick + keyboard) ‚Äî‚Äî
  const joy = document.getElementById('joy');
  const stick = document.getElementById('stick');
  let joyOn=false, joyVec={x:0,y:0};
  function joySet(e){
    const r=joy.getBoundingClientRect(); const t=e.touches?e.touches[0]:e;
    const x=t.clientX-r.left, y=t.clientY-r.top; const dx=x-r.width/2, dy=y-r.height/2; const d=Math.hypot(dx,dy); const max=r.width*0.35; const cl=Math.min(d,max); const nx=dx/d||0, ny=dy/d||0;
    stick.style.transform=`translate(calc(-50% + ${(nx*cl)}px), calc(-50% + ${(ny*cl)}px))`; joyVec.x=Math.max(-1,Math.min(1,dx/max)); joyVec.y=Math.max(-1,Math.min(1,dy/max));
  }
  joy.addEventListener('touchstart',e=>{joyOn=true;joySet(e)},{passive:false});
  joy.addEventListener('touchmove',e=>{if(joyOn) joySet(e)},{passive:false});
  joy.addEventListener('touchend',()=>{joyOn=false; stick.style.transform='translate(-50%,-50%)'; joyVec.x=joyVec.y=0});
  const keys={}; addEventListener('keydown',e=>{keys[e.key]=true}); addEventListener('keyup',e=>{keys[e.key]=false});

  // ‚Äî‚Äî Sprites (tiny pixel maps) ‚Äî‚Äî
  const PAL={
    K:'#05070b', W:'#ecf1ff', B:'#3a5acb', R:'#ff4d6d', Y:'#ffd166', G:'#2ee6a6', S:'#7f8aa5'
  };
  // 16x16 citizen with sign (ü™ß)
  const SPR_CIT=[
    '................',
    '....BBBB........',
    '...BWWWWB.......',
    '..BWWSWWWB......',
    '..BWWWWWWB......',
    '...BWWWWB.......',
    '....BBBB........',
    '......SS....YY..',
    '...SSSSS..YYYY..',
    '....SSS...YYYY..',
    '......S...YYYY..',
    '...RRRRRRR......',
    '..RWWWWWWW......',
    '..RWWWWWWW......',
    '..RWWWWWWW......',
    '...RRRRRRR......',
  ];
  // 16x16 decree (paper)
  const SPR_DEC=[
    '................',
    '.....WWWWWWW....',
    '....WWWWWWWWW...',
    '...WWWWWWWWWW..',
    '..WWWWWWWWWWW..',
    '..WWWWSSSWWWW..',
    '..WWWSSSSSWWW..',
    '..WWWSSSSSWWW..',
    '..WWWWSSSWWWW..',
    '..WWWWWWWWWWW..',
    '..WWWWWWWWWWW..',
    '..WWWWWWWWWWW..',
    '...WWWWWWWWW...',
    '....WWWWWWW....',
    '................',
    '................',
  ];
  // 16x16 TV Expert (talking head)
  const SPR_TV=[
    '................',
    '....BBBBBBBB....',
    '...BWWWWWWWWB...',
    '..BWWWWWWWWWWB..',
    '..BWWWSWWSWWWb..',
    '..BWWWWWWWWWWB..',
    '..BWWWWSWWWWWb..',
    '..BWWWWWWWWWWB..',
    '..BWWWBBBBWWWb..',
    '..BWWWBRRBWWWb..',
    '..BWWWBBBBWWWb..',
    '..BWWWWWWWWWWB..',
    '..BBBBBBBBBBBB..',
    '.....BBBBBB.....',
    '......BBBB......',
    '................',
  ];

  function drawSprite(g,x,y,pix,scale=1){
    for(let j=0;j<pix.length;j++){
      const row=pix[j];
      for(let i=0;i<row.length;i++){
        const c=row[i]; if(c==='.') continue; const col=PAL[c.toUpperCase()]||'#fff';
        g.fillStyle=col; g.fillRect((x+i)*scale,(y+j)*scale,scale,scale);
      }
    }
  }

  // ‚Äî‚Äî Helpers ‚Äî‚Äî
  function clamp(v,a,b){return v<a?a:v>b?b:v}
  function rand(a,b){return a+Math.random()*(b-a)}

  // ‚Äî‚Äî Enemies ‚Äî‚Äî
  function spawn(type){
    const side=Math.random()<.5? -1:1; const ex = side<0? -10: VIRT_W+10; const ey=rand(10,VIRT_H-10);
    if(type==='dec'){ state.enemies.push({t:'dec',x:ex,y:ey,r:6,spd:rand(16,20),hp:20,max:20}); }
    else { state.enemies.push({t:'tv',x:ex,y:ey,r:7,spd:rand(12,16),hp:30,max:30}); }
  }

  // ‚Äî‚Äî Loop ‚Äî‚Äî
  let last=0, spawnAcc=0;
  function loop(now){ if(!state.running){requestAnimationFrame(loop);return} if(!now) now=performance.now(); const dt=Math.min(0.04,(now-last)/1000); last=now; update(dt); render(); requestAnimationFrame(loop); }

  function update(dt){
    state.time+=dt; const t=Math.floor(state.time); timerEl.textContent = (""+Math.floor(t/60)).padStart(2,'0')+":"+(""+(t%60)).padStart(2,'0');

    // Move input
    let vx=joyVec.x, vy=joyVec.y; if(keys['ArrowUp']||keys['w']) vy-=1; if(keys['ArrowDown']||keys['s']) vy+=1; if(keys['ArrowLeft']||keys['a']) vx-=1; if(keys['ArrowRight']||keys['d']) vx+=1; const l=Math.hypot(vx,vy)||1; vx/=l; vy/=l;
    const p=state.player; p.x=clamp(p.x+vx*p.spd*dt,8,VIRT_W-8); p.y=clamp(p.y+vy*p.spd*dt,8,VIRT_H-8); p.dir=Math.atan2(vy,vx);
    if(p.ifr>0) p.ifr-=dt;

    // Fire
    const w=state.weapon; w.cd-=dt; if(w.cd<=0){
      const base = p.dir || 0; for(let i=0;i<w.bullets;i++){ const a = base + (i-(w.bullets-1)/2)*w.spread + rand(-0.05,0.05); state.proj.push({x:p.x,y:p.y,a,spd:w.speed,dmg:w.dmg,life:1}); }
      w.cd=w.rate;
    }

    // Spawn pacing
    spawnAcc+=dt; const rate = Math.max(0.35, 1.0 - state.time*0.015);
    if(spawnAcc>=rate){ spawnAcc=0; spawn(Math.random()<0.55?'dec':'tv'); }

    // Enemies move & hit
    for(let i=state.enemies.length-1;i>=0;i--){ const e=state.enemies[i]; const dx=p.x-e.x, dy=p.y-e.y; const d=Math.hypot(dx,dy)||1; e.x+=dx/d*e.spd*dt; e.y+=dy/d*e.spd*dt; if(d< e.r+p.r && p.ifr<=0){ p.hp-=8; p.ifr=0.6; if(p.hp<=0){ gameOver(); } }
    }

    // Projectiles
    for(let i=state.proj.length-1;i>=0;i--){ const b=state.proj[i]; b.x+=Math.cos(b.a)*b.spd*dt; b.y+=Math.sin(b.a)*b.spd*dt; b.life-=dt*0.8; if(b.life<=0){ state.proj.splice(i,1); continue }
      for(let j=state.enemies.length-1;j>=0;j--){ const e=state.enemies[j]; const d=Math.hypot(b.x-e.x,b.y-e.y); if(d< e.r+2){ e.hp-=b.dmg; state.proj.splice(i,1); if(e.hp<=0){ state.enemies.splice(j,1); state.gold++; goldEl.textContent='üó≥Ô∏è '+state.gold; } break; }
    }}
  }

  // ‚Äî‚Äî Render ‚Äî‚Äî
  function render(){
    // world
    g.clearRect(0,0,VIRT_W,VIRT_H);
    drawBackground(g);
    // orbs (future)
    // enemies
    for(const e of state.enemies){ if(e.t==='dec') drawSprite(g, Math.round(e.x-8), Math.round(e.y-8), SPR_DEC,1); else drawSprite(g, Math.round(e.x-8), Math.round(e.y-8), SPR_TV,1); }
    // projectiles
    g.fillStyle='#7ab8ff'; for(const b of state.proj){ g.fillRect(Math.round(b.x-1), Math.round(b.y-1), 2,2); }
    // player
    drawSprite(g, Math.round(state.player.x-8), Math.round(state.player.y-8), SPR_CIT,1);

    // blit to screen (nearest-neighbor)
    ctx.imageSmoothingEnabled=false; ctx.clearRect(0,0,screen.width,screen.height);
    ctx.drawImage(off,0,0,off.width,off.height,0,0,off.width*S,off.height*S);

    // CRT scanlines & vignette
    drawCRT();
  }

  function drawBackground(g){
    // tiles
    for(let y=0;y<VIRT_H;y+=8){ for(let x=0;x<VIRT_W;x+=8){ const c = ((x+y)>>3)%2 ? '#0f1524' : '#0c1220'; g.fillStyle=c; g.fillRect(x,y,8,8); }}
    // graffiti
    g.fillStyle='rgba(255,255,255,.05)'; g.fillRect(6,6,50,10); g.fillStyle='rgba(255,77,109,.25)'; g.fillRect(6,6,3,10);
  }

  function drawCRT(){
    const w=crt.width, h=crt.height; crtx.clearRect(0,0,w,h);
    // scanlines
    crtx.fillStyle='rgba(255,255,255,.06)'; for(let y=0;y<h;y+=2){ crtx.fillRect(0,y,w,1); }
    // vignette
    const grd=crtx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.2,w/2,h/2,Math.max(w,h)*0.7);
    grd.addColorStop(0,'rgba(0,0,0,0)'); grd.addColorStop(1,'rgba(0,0,0,.5)');
    crtx.fillStyle=grd; crtx.fillRect(0,0,w,h);
  }

  function gameOver(){ state.over=true; state.running=false; overEl.style.display='grid'; statsEl.textContent = `Temps ${(timerEl.textContent)} ‚Äî LV ${state.level} ‚Äî üó≥Ô∏è ${state.gold}`; }

})();
</script>
</body>
</html>
